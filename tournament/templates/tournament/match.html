{% extends "tournament/base.html" %}
{% load tournament_extras static %}

{% block title %}{{ match.seed }}{% endblock %}

{% block content %}
<div id="container" class="container">
    <div class="row">
        <div class="col-md-12">
            <table class="table">
                <tr>
                    <th>Time</th>
                    <th>Opponents</th>
                    <th>Dimensions</th>
                    <th>Seed</th>
                </tr>
                <tr>
                    <td>{{ match.date|date:"m/d/Y" }} {{ match.date|time:"h:i:s A" }}</td>
                    <td>{% order_bots_by_results match %}</td>
                    <td>{{ match.width }}x{{ match.height }}</td>
                    <td>{{ match.seed }}</td>
                </tr>
            </table>
            <div id="pageContent" class="pageContent text-center"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
    .glyphicon-refresh-animate {
        -animation: spin .7s infinite linear;
        -webkit-animation: spin2 .7s infinite linear;
    }
    @-webkit-keyframes spin2 {
        from { -webkit-transform: rotate(0deg);}
        to { -webkit-transform: rotate(360deg);}
    }
    @keyframes spin {
        from { transform: scale(1) rotate(0deg);}
        to { transform: scale(1) rotate(360deg);}
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/seedrandom/2.4.0/seedrandom.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.2.2/pixi.min.js"></script>
<script src="{%  static "tournament/lib/xss.js" %}"></script>
<script src="{%  static "tournament/script/parsereplay.js" %}"></script>
<script src="{%  static "tournament/script/visualizer.js" %}"></script>
<script type="module">
    import initBrotli, { decompress as brotliDecompress } from "https://unpkg.com/brotli-wasm@3.0.1/pkg.web/brotli_wasm.js";
    await initBrotli();
    async function textFromAnyURL(url) {
        $("#pageContent").html("<h1><span class=\"glyphicon glyphicon-refresh glyphicon-refresh-animate\"></span> Loading replay...</h1>");

        try {
            const resp = await fetch(url);

            if (!resp.ok) {
                $("#pageContent").html(`<h1>Gamefile not found</h1><p>The gamefile at "${url}" could not be found.</p>`);
                return;
            }

            $("#pageContent").html("<h1><span class=\"glyphicon glyphicon-refresh glyphicon-refresh-animate\"></span> Preparing replay...</h1>");

            const uint8 = new Uint8Array(await resp.arrayBuffer());
            const brotliDecoded = brotliDecompress(uint8);
            const text = new TextDecoder().decode(brotliDecoded);
            showGame(textToGame(text, url), $("#pageContent"), null, null, true, false, true);

        } catch (err) {
            console.error(err);
            $("#pageContent").html(`<h1>Error loading gamefile</h1><p>${err}</p>`);
        }
    }

    // usage
    textFromAnyURL("{{ match.replay.url }}");
</script>
{% endblock %}
